---
import SkillsPills from '@components/about/SkillsPills.astro';

const {
  description: _description,
  totalYears: _totalYears,
  nationality: _nationality,
  iLiveIn: _iLiveIn,
  skills: _skills
} = Astro.props as {
  description?: string;
  totalYears?: number;
  nationality?: string;
  iLiveIn?: string;
  skills?: string[];
};

const description: string = _description ?? '';
const totalYears: number = _totalYears ?? 0;
const nationality: string = _nationality ?? '';
const iLiveIn: string = _iLiveIn ?? '';
const skills: string[] = Array.isArray(_skills) ? _skills : [];

/* ------------------ Helpers para pa√≠s/emoji ------------------ */
function extractCountry(input?: string): string {
  if (!input) return '';
  let s = String(input).trim();
  if (s.includes(',')) s = s.split(',').pop() ?? s;
  s = s.replace(/\(.+?\)/g, '').trim();
  return s;
}
function removeDiacritics(s: string): string {
  try { return s.normalize('NFD').replace(/[\u0300-\u036f]/g, ''); } catch { return s; }
}
const rawNameToIso: Record<string, string> = {
  'Colombia':'CO','Espa√±a':'ES','Spain':'ES','Mexico':'MX','M√©xico':'MX',
  'United States':'US','USA':'US','United Kingdom':'GB','UK':'GB','England':'GB',
  'Germany':'DE','France':'FR','Italy':'IT','Portugal':'PT','Brazil':'BR','Brasil':'BR',
  'Argentina':'AR','Chile':'CL','Peru':'PE','Per√∫':'PE','Netherlands':'NL','Belgium':'BE',
  'Ireland':'IE','Australia':'AU','Canada':'CA','New Zealand':'NZ'
};
const nameToIso: Record<string,string> = {};
Object.entries(rawNameToIso).forEach(([name,iso]) => {
  nameToIso[removeDiacritics(name).toLowerCase()] = iso;
});
function isoToFlagEmoji(iso?: string): string {
  if (!iso || iso.length !== 2) return 'üåç';
  const OFFSET = 0x1F1E6;
  const chars = iso.toUpperCase().split('').map(ch => {
    const code = ch.charCodeAt(0);
    if (code >= 65 && code <= 90) return OFFSET + (code - 65);
    return NaN;
  }).filter(n => !Number.isNaN(n)) as number[];
  if (chars.length !== 2) return 'üåç';
  return String.fromCodePoint(chars[0], chars[1]);
}
function countryEmojiFromText(text?: string): string {
  const countryRaw = extractCountry(text);
  if (!countryRaw) return 'üåç';
  const key = removeDiacritics(countryRaw).toLowerCase();
  let iso = nameToIso[key];
  if (!iso && key.includes(' ')) {
    const parts = key.split(/\s+/);
    iso = nameToIso[parts[parts.length - 1]] ?? nameToIso[parts[0]];
  }
  return iso ? isoToFlagEmoji(iso) : 'üåç';
}
const natCountry: string = extractCountry(nationality);
const natEmoji: string = countryEmojiFromText(nationality);
const liveCountry: string = extractCountry(iLiveIn);
const liveEmoji: string = countryEmojiFromText(iLiveIn);
const displayNat: string = natCountry || nationality || 'N/A';
const displayLive: string = liveCountry || iLiveIn || 'N/A';
---

<article class="w-full max-w-6xl mx-auto my-2 px-4">
  <div class="bg-white/50 shadow-xs rounded-2xl p-6 md:p-8 border border-sky-100">
    
    <!-- Header minimalista con info clave -->
    <div class="flex flex-col sm:flex-row items-center justify-between gap-6 mb-8">
      
      <!-- Experiencia - m√°s prominente -->
      <div class="text-center sm:text-left">
        <div class="text-xl md:text-2xl font-bold text-sky-700 mb-1">{totalYears}+</div>
        <div class="text-sm text-gray-600">a√±os de experiencia</div>
      </div>

      <!-- Ubicaci√≥n - m√°s sutil -->
      <div class="flex items-center gap-4 text-sm text-gray-600">
        <div class="flex items-center gap-2">
          <span class="text-lg">{natEmoji}</span>
          <span>{displayNat}</span>
        </div>
        <div class="text-gray-400">‚Üí</div>
        <div class="flex items-center gap-2">
          <span class="text-lg">{liveEmoji}</span>
          <span>{displayLive}</span>
        </div>
      </div>

      <!-- Estado disponible - muy sutil -->
      <div class="flex items-center gap-2 text-xs text-green-600">
        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
        <span>Disponible</span>
      </div>
    </div>

    <!-- Descripci√≥n -->
    <div class="prose prose-sm prose-gray max-w-none mb-8">
      <p class="text-gray-700 leading-relaxed text-base font-light">
        {description}
      </p>
    </div>

    <!-- Skills -->
    <div class="bg-white/10 rounded-xl p-4 border border-sky-100/50">
      <SkillsPills skills={skills ?? []} />
    </div>
  </div>
</article>